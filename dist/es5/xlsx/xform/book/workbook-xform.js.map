{"version":3,"sources":["../../../../../lib/xlsx/xform/book/workbook-xform.js"],"names":["_","require","utils","colCache","XmlStream","BaseXform","StaticXform","ListXform","DefinedNameXform","SheetXform","WorkbookViewXform","WorkbookPropertiesXform","WorkbookXform","module","exports","map","fileVersion","STATIC_XFORMS","workbookPr","bookViews","tag","count","childXform","sheets","definedNames","calcPr","inherits","WORKBOOK_ATTRIBUTES","xmlns","$","appName","lastEdited","lowestEdited","rupBuild","calcId","prepare","model","worksheets","printAreas","index","forEach","sheet","pageSetup","printArea","definedName","name","ranges","replace","localSheetId","push","printTitlesRow","titlesRows","split","length","concat","media","medium","i","type","render","xmlStream","openXml","StdDocAttributes","openNode","properties","views","closeNode","parseOpen","node","parser","parseText","text","parseClose","undefined","reconcile","rels","workbookRels","reduce","rel","Id","worksheet","rId","worksheetHash","Target","id","state","each","range","decodeEx","dimensions","longRange"],"mappings":"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","file":"workbook-xform.js","sourcesContent":["/**\r\n * Copyright (c) 2016 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar _ = require('../../../utils/under-dash');\r\n\r\nvar utils = require('../../../utils/utils');\r\nvar colCache = require('../../../utils/col-cache');\r\nvar XmlStream = require('../../../utils/xml-stream');\r\n\r\nvar BaseXform = require('../base-xform');\r\nvar StaticXform = require('../static-xform');\r\nvar ListXform = require('../list-xform');\r\nvar DefinedNameXform = require('./defined-name-xform');\r\nvar SheetXform = require('./sheet-xform');\r\nvar WorkbookViewXform = require('./workbook-view-xform');\r\nvar WorkbookPropertiesXform = require('./workbook-properties-xform');\r\n\r\nvar WorkbookXform = module.exports = function() {\r\n  this.map = {\r\n    fileVersion: WorkbookXform.STATIC_XFORMS.fileVersion,\r\n    workbookPr: new WorkbookPropertiesXform(),\r\n    bookViews: new ListXform({tag: 'bookViews', count: false, childXform: new WorkbookViewXform()}),\r\n    sheets: new ListXform({tag: 'sheets', count: false, childXform: new SheetXform()}),\r\n    definedNames: new ListXform({tag: 'definedNames', count: false, childXform: new DefinedNameXform()}),\r\n    calcPr: WorkbookXform.STATIC_XFORMS.calcPr\r\n  };\r\n};\r\n\r\nutils.inherits(WorkbookXform, BaseXform, {\r\n  WORKBOOK_ATTRIBUTES: {\r\n    xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\r\n    'xmlns:r': 'http://schemas.openxmlformats.org/officeDocument/2006/relationships',\r\n    'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\r\n    'mc:Ignorable': 'x15',\r\n    'xmlns:x15': 'http://schemas.microsoft.com/office/spreadsheetml/2010/11/main'\r\n  },\r\n  STATIC_XFORMS: {\r\n    fileVersion: new StaticXform({tag: 'fileVersion', $: {appName: 'xl', lastEdited: 5, lowestEdited: 5, rupBuild: 9303}}),\r\n    calcPr: new StaticXform({tag: 'calcPr', $: {calcId: 171027}})\r\n  }\r\n}, {\r\n\r\n  prepare: function(model) {\r\n    model.sheets = model.worksheets;\r\n\r\n    // collate all the print areas from all of the sheets and add them to the defined names\r\n    var printAreas = [];\r\n    var index = 0; // sheets is sparse array - calc index manually\r\n    model.sheets.forEach(function(sheet) {\r\n      if (sheet.pageSetup && sheet.pageSetup.printArea) {\r\n        const definedName = {\r\n          name: '_xlnm.Print_Area',\r\n          ranges: ['\\'' + sheet.name.replace('\\'', '\\'\\'') + '\\'!' + sheet.pageSetup.printArea],\r\n          localSheetId: index\r\n        };\r\n        printAreas.push(definedName);\r\n      }\r\n      if (sheet.pageSetup && sheet.pageSetup.printTitlesRow) {\r\n        const titlesRows = sheet.pageSetup.printTitlesRow.split(':');\r\n        const definedName = {\r\n            name: '_xlnm.Print_Titles',\r\n            // only support row, col is not supported (In Excel: Page Layout -> Print Titles)\r\n            ranges: ['\\'' + sheet.name.replace('\\'', '\\'\\'') + '\\'!' + titlesRows[0] + ':' + titlesRows[1]],\r\n            localSheetId: index\r\n        };\r\n        printAreas.push(definedName);\r\n      }\r\n      index++;\r\n    });\r\n    if (printAreas.length) {\r\n      model.definedNames = model.definedNames.concat(printAreas);\r\n    }\r\n\r\n    model.media && model.media.forEach(function(medium, i) {\r\n      // assign name\r\n      medium.name = medium.type + (i + 1);\r\n    });\r\n  },\r\n\r\n  render: function(xmlStream, model) {\r\n    xmlStream.openXml(XmlStream.StdDocAttributes);\r\n    xmlStream.openNode('workbook', WorkbookXform.WORKBOOK_ATTRIBUTES);\r\n\r\n    this.map.fileVersion.render(xmlStream);\r\n    this.map.workbookPr.render(xmlStream, model.properties);\r\n    this.map.bookViews.render(xmlStream, model.views);\r\n    this.map.sheets.render(xmlStream, model.sheets);\r\n    this.map.definedNames.render(xmlStream, model.definedNames);\r\n    this.map.calcPr.render(xmlStream);\r\n\r\n    xmlStream.closeNode();\r\n  },\r\n\r\n  parseOpen: function(node) {\r\n    if (this.parser) {\r\n      this.parser.parseOpen(node);\r\n      return true;\r\n    }\r\n    switch (node.name) {\r\n      case 'workbook':\r\n        return true;\r\n      default:\r\n        this.parser = this.map[node.name];\r\n        if (this.parser) {\r\n          this.parser.parseOpen(node);\r\n        }\r\n        return true;\r\n    }\r\n  },\r\n  parseText: function(text) {\r\n    if (this.parser) {\r\n      this.parser.parseText(text);\r\n    }\r\n  },\r\n  parseClose: function(name) {\r\n    if (this.parser) {\r\n      if (!this.parser.parseClose(name)) {\r\n        this.parser = undefined;\r\n      }\r\n      return true;\r\n    }\r\n    switch (name) {\r\n      case 'workbook':\r\n        this.model = {\r\n          sheets: this.map.sheets.model,\r\n          properties: this.map.workbookPr.model || {},\r\n          views: this.map.bookViews.model\r\n        };\r\n        if (this.map.definedNames.model) {\r\n          this.model.definedNames = this.map.definedNames.model;\r\n        }\r\n\r\n        return false;\r\n      default:\r\n        // not quite sure how we get here!\r\n        return true;\r\n    }\r\n  },\r\n\r\n  reconcile: function(model) {\r\n    var rels = (model.workbookRels || []).reduce(function(map, rel) {\r\n      map[rel.Id] = rel;\r\n      return map;\r\n    }, {});\r\n\r\n    // reconcile sheet ids, rIds and names\r\n    var worksheets = [];\r\n    var worksheet;\r\n    var index = 0;\r\n\r\n    (model.sheets || []).forEach(function(sheet) {\r\n      var rel = rels[sheet.rId];\r\n      if (!rel) {\r\n        return;\r\n      }\r\n      worksheet = model.worksheetHash['xl/' + rel.Target];\r\n      // If there are \"chartsheets\" in the file, rel.Target will\r\n      // come out as chartsheets/sheet1.xml or similar here, and\r\n      // that won't be in model.worksheetHash.\r\n      // As we don't have the infrastructure to support chartsheets,\r\n      // we will ignore them for now:\r\n      if (worksheet) {\r\n        worksheet.name = sheet.name;\r\n        worksheet.id = sheet.id;\r\n        worksheet.state = sheet.state;\r\n        worksheets[index++] = worksheet;\r\n      }\r\n    });\r\n\r\n    // reconcile print areas\r\n    var definedNames = [];\r\n    _.each(model.definedNames, function(definedName) {\r\n      if (definedName.name === '_xlnm.Print_Area') {\r\n        worksheet = worksheets[definedName.localSheetId];\r\n        if (worksheet) {\r\n          if (!worksheet.pageSetup) {\r\n            worksheet.pageSetup = {};\r\n          }\r\n          const range = colCache.decodeEx(definedName.ranges[0]);\r\n          worksheet.pageSetup.printArea = range.dimensions;\r\n        }\r\n      } else if (definedName.name === '_xlnm.Print_Titles') {\r\n        worksheet = worksheets[definedName.localSheetId];\r\n        if (worksheet) {\r\n          if (!worksheet.pageSetup) {\r\n            worksheet.pageSetup = {};\r\n          }\r\n          const longRange = definedName.ranges[0].split('!');\r\n          const range = longRange[longRange.length - 1];\r\n          worksheet.pageSetup.printTitlesRow = range;\r\n        }\r\n      } else {\r\n        definedNames.push(definedName);\r\n      }\r\n    });\r\n    model.definedNames = definedNames;\r\n\r\n    // used by sheets to build their image models\r\n    model.media.forEach((media, i) => {\r\n      media.index = i;\r\n    });\r\n  }\r\n});\r\n"]}